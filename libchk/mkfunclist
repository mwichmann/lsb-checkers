#!/usr/bin/perl

use CGI;
use Getopt::Long;
use Mysql;

use Env qw(LSBUSER LSBDBPASSWD LSBDB LSBDBHOST);

sub usage()
{
print STDERR "mkfunclist -a <archname>\n";
die;
}

# Uncomment to trace SQL statments
#$trace=1;

#
# 1) process the arguments
#
GetOptions("a=s" => \$archname);

if( !$archname ) { usage(); }

sub mklibsyms($$)
{
local($libname,$lid)=@_;

$select = "SELECT DISTINCT Iname,Vname FROM Interface,LibGroup,LGInt ";
$select.= "LEFT JOIN Version ON Vid=Iversion ";
$select.= "WHERE Interface.Iid=LGInt.LGIint ";
$select.= "AND LGInt.LGIlibg=LibGroup.LGid ";
$select.= "AND LibGroup.LGlib=$lid ";
$select.= "ORDER BY Iname ";

#print $select;

$lsth = $Dbh->query($select) || die $Dbh->errmsg();

open(LIB,">$libname.c");
print LIB "#include \"elfchk.h\"\n";
print LIB "struct versym ".$libname."[] = {\n";
for(1..$lsth->numrows) {
	%entry=$lsth->fetchhash;
	printf LIB "\t{\"%s\",\"%s\"},\n",$entry{'Iname'},$entry{'Vname'};
}
print LIB "\t{0,0}};\n";
close(LIB);
}

#
# 2) Establish connection to the database
#

$Dbh = Mysql->connect($LSBDBHOST,$LSBDB,$LSBUSER, $LSBDBPASSWD) || die $Mysql::db_errstr;

#
# 3) get & print the architecture info
#
$select = "SELECT * FROM Architecture WHERE ";
$select.= "Aname='All'";
print STDERR $select,"\n" if $trace;
$sth = $Dbh->query($select) || die $select."\n".$Dbh->errmsg();

%entry=$sth->fetchhash;
$AllAid=$entry{'Aid'};

$select = "SELECT * FROM Architecture WHERE ";
$select.= "Aname=".$Dbh->quote($archname);
print STDERR $select,"\n" if $trace;
$sth = $Dbh->query($select) || die $select."\n".$Dbh->errmsg();

%entry=$sth->fetchhash;
$Aid=$entry{'Aid'};

open(LIBS,">libs.c");
print LIBS "/* Generated file */\n";
print LIBS "#include \"libs.h\"\n\n";
print LIBS "extern void check_lib(char *libname, struct versym entries[]);\n";

print LIBS "void check_libs()\n{\n";

open(LIBSH,">libs.h");
print LIBSH "/* Generated file */\n";

open(MAKE,">libs.mk");
print MAKE "# Generated file #\n";
print MAKE "LIBOBJS = \\\n";

$select = "SELECT DISTINCT Lid,Lrunname FROM Library ";
$select.= "WHERE Lstd='Yes' ";
$select.= "AND Larch IN ($Aid,$AllAid) ";
$select.= "ORDER BY Lrunname ";

#print $select;

$sth = $Dbh->query($select) || die $Dbh->errmsg();

for(1..$sth->numrows) {
	%entry=$sth->fetchhash;
	$libname=$entry{'Lrunname'};
	$libname =~ s/\./_/g;
	$libname =~ s/-/_/g;
	print LIBS "check_lib(\"".$entry{'Lrunname'}."\",$libname);\n";
	print LIBSH "extern char *".$libname."[];\n";
	print MAKE "\t$libname.o \\\n";
	mklibsyms($libname,$entry{'Lid'});
}

print LIBS "}\n";
close(LIBS);
close(LIBH);
close(MAKE);
