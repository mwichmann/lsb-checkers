#!/usr/bin/perl

use CGI;
use Mysql;
use Getopt::Long;

use Env qw(LSBUSER LSBDBPASSWD LSBDB LSBDBHOST);

sub usage()
{
print STDERR "mksectinfo -v lsbversion\n";
die;
}

GetOptions("v=s" => \$lsbversion);
if( !$lsbversion ) { usage(); }

$Dbh = Mysql->connect($LSBDBHOST,$LSBDB,$LSBUSER, $LSBDBPASSWD) || die $Mysql::db_errstr;

$select = "SELECT DISTINCT * FROM SectionTypes, ElfSections ";
$select.= "LEFT JOIN ArchES ON AESesid=ESid ";
$select.= "LEFT JOIN Architecture ON Aid=AESaid ";
$select.= "WHERE AEStype=STid ";
$select.= "AND (AESappearedin <= '$lsbversion' and AESappearedin<>'') ";
$select.= "AND (AESwithdrawnin IS NULL OR AESwithdrawnin > '$lsbversion') ";
$select.= "ORDER BY ESname ";

#print "$select\n";

$sth = $Dbh->query($select) || die $Dbh->errmsg();

print "/* Generated file - Do Not Edit */\n";
print "#include \"elfchk.h\"\n";
print "#include \"sections.h\"\n\n";

print "struct SectionInfo SectionInfo[] = {\n";
for(1..$sth->numrows) {
	%entry=$sth->fetchhash;
	
	if (not $entry{'Aname'}) {
		next; # unsupported architecture found
	}
	
	if( $entry{'Aname'} ne "All" ) {
		print "#if ".$entry{'Asymbol'}."\n";
	}
	printf "\t{\"%s\",",$entry{'ESname'};
	printf "%s,",$entry{'STname'};
	printf "%s,",$entry{'AESattributes'};
	@typename=split('_',$entry{'STname'},2);
	if( @typename[1] ) {
		printf "check%s},\n",@typename[1];
	} else {
		printf "checkDUMMY},\n";
	}
	if( $entry{'Aname'} ne "All" ) {
		print "#endif /* ".$entry{'Asymbol'}." */\n";
	}
}
print "\t};\n\n";
print "int numSectionInfo = sizeof(SectionInfo)/sizeof(struct SectionInfo);\n";

